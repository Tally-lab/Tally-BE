package com.tally.service;

import com.tally.domain.*;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.UUID;

@Slf4j
@Service
@RequiredArgsConstructor
public class ReportGenerationService {
    private final ContributionAnalysisService analysisService;

    /**
     * Markdown ë¦¬í¬íŠ¸ ìƒì„±
     */
    public Report generateMarkdownReport(String token, String owner, String repo, String username) {
        ContributionStats stats = analysisService.analyzeContribution(token, owner, repo, username);
        List<PullRequest> userPRs = analysisService.getUserPullRequests(token, owner, repo, username);
        List<Issue> userIssues = analysisService.getUserIssues(token, owner, repo, username);

        StringBuilder markdown = new StringBuilder();

        // í—¤ë”
        markdown.append(String.format("# %s ê¸°ì—¬ë„ ë¦¬í¬íŠ¸\n\n", repo));
        markdown.append(String.format("**ë¶„ì„ ëŒ€ìƒ:** %s\n", username));
        markdown.append(String.format("**ìƒì„± ì¼ì‹œ:** %s\n\n",
                LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"))));

        markdown.append("---\n\n");

        // ê¸°ë³¸ ì •ë³´
        markdown.append("## ê¸°ë³¸ ì •ë³´\n\n");
        markdown.append(String.format("- **ì´ ì»¤ë°‹ ìˆ˜:** %dê°œ\n", stats.getTotalCommits()));
        markdown.append(String.format("- **ë‚´ ì»¤ë°‹ ìˆ˜:** %dê°œ\n", stats.getUserCommits()));
        markdown.append(String.format("- **ê¸°ì—¬ë„:** %.1f%%\n\n", stats.getCommitPercentage()));

        // êµ¬í˜„í•œ ê¸°ëŠ¥ (PR)
        markdown.append("## êµ¬í˜„í•œ ê¸°ëŠ¥\n\n");
        if (userPRs.isEmpty()) {
            markdown.append("- ì‘ì„±í•œ Pull Requestê°€ ì—†ìŠµë‹ˆë‹¤.\n\n");
        } else {
            for (PullRequest pr : userPRs) {
                String state = "merged".equals(pr.getState()) || pr.getMergedAt() != null ? "âœ…" :
                        "closed".equals(pr.getState()) ? "âŒ" : "ğŸ”„";
                markdown.append(String.format("- %s %s (PR #%d)\n", state, pr.getTitle(), pr.getNumber()));
            }
            markdown.append("\n");
        }

        // í•´ê²°í•œ ë¬¸ì œ (Issue)
        markdown.append("## í•´ê²°í•œ ë¬¸ì œ\n\n");
        if (userIssues.isEmpty()) {
            markdown.append("- ì‘ì„±í•œ Issueê°€ ì—†ìŠµë‹ˆë‹¤.\n\n");
        } else {
            for (Issue issue : userIssues) {
                String state = "closed".equals(issue.getState()) ? "âœ…" : "ğŸ”„";
                markdown.append(String.format("- %s %s (Issue #%d)\n", state, issue.getTitle(), issue.getNumber()));
            }
            markdown.append("\n");
        }

        markdown.append("---\n\n");
        markdown.append("*Generated by Tally*\n");

        return Report.builder()
                .id(UUID.randomUUID().toString())
                .userId(username)
                .contributionStatsId(stats.getId())
                .format(Report.ReportFormat.MARKDOWN)
                .content(markdown.toString())
                .generatedAt(LocalDateTime.now())
                .build();
    }

    /**
     * HTML ë¦¬í¬íŠ¸ ìƒì„±
     */
    public Report generateHtmlReport(String token, String owner, String repo, String username) {
        ContributionStats stats = analysisService.analyzeContribution(token, owner, repo, username);
        List<PullRequest> userPRs = analysisService.getUserPullRequests(token, owner, repo, username);
        List<Issue> userIssues = analysisService.getUserIssues(token, owner, repo, username);

        StringBuilder html = new StringBuilder();

        html.append("<!DOCTYPE html>\n");
        html.append("<html lang=\"ko\">\n");
        html.append("<head>\n");
        html.append("    <meta charset=\"UTF-8\">\n");
        html.append("    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n");
        html.append(String.format("    <title>%s ê¸°ì—¬ë„ ë¦¬í¬íŠ¸</title>\n", repo));
        html.append("    <style>\n");
        html.append("        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; background-color: #f5f5f5; }\n");
        html.append("        .container { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }\n");
        html.append("        h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }\n");
        html.append("        h2 { color: #555; margin-top: 30px; }\n");
        html.append("        .stats { background: #e8f5e9; padding: 20px; border-radius: 5px; margin: 20px 0; }\n");
        html.append("        .stats p { margin: 10px 0; font-size: 18px; }\n");
        html.append("        .list-item { padding: 10px; margin: 5px 0; background: #f9f9f9; border-left: 4px solid #4CAF50; }\n");
        html.append("        .footer { text-align: center; margin-top: 40px; color: #999; font-size: 14px; }\n");
        html.append("    </style>\n");
        html.append("</head>\n");
        html.append("<body>\n");
        html.append("    <div class=\"container\">\n");

        html.append(String.format("        <h1>%s ê¸°ì—¬ë„ ë¦¬í¬íŠ¸</h1>\n", repo));
        html.append(String.format("        <p><strong>ë¶„ì„ ëŒ€ìƒ:</strong> %s</p>\n", username));
        html.append(String.format("        <p><strong>ìƒì„± ì¼ì‹œ:</strong> %s</p>\n",
                LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"))));

        html.append("        <div class=\"stats\">\n");
        html.append("            <h2>ê¸°ë³¸ ì •ë³´</h2>\n");
        html.append(String.format("            <p>ì´ ì»¤ë°‹ ìˆ˜: <strong>%dê°œ</strong></p>\n", stats.getTotalCommits()));
        html.append(String.format("            <p>ë‚´ ì»¤ë°‹ ìˆ˜: <strong>%dê°œ</strong></p>\n", stats.getUserCommits()));
        html.append(String.format("            <p>ê¸°ì—¬ë„: <strong>%.1f%%</strong></p>\n", stats.getCommitPercentage()));
        html.append("        </div>\n");

        html.append("        <h2>êµ¬í˜„í•œ ê¸°ëŠ¥ (Pull Requests)</h2>\n");
        if (userPRs.isEmpty()) {
            html.append("        <p>ì‘ì„±í•œ Pull Requestê°€ ì—†ìŠµë‹ˆë‹¤.</p>\n");
        } else {
            for (PullRequest pr : userPRs) {
                String state = "merged".equals(pr.getState()) || pr.getMergedAt() != null ? "âœ…" :
                        "closed".equals(pr.getState()) ? "âŒ" : "ğŸ”„";
                html.append(String.format("        <div class=\"list-item\">%s %s <small>(PR #%d)</small></div>\n",
                        state, pr.getTitle(), pr.getNumber()));
            }
        }

        html.append("        <h2>í•´ê²°í•œ ë¬¸ì œ (Issues)</h2>\n");
        if (userIssues.isEmpty()) {
            html.append("        <p>ì‘ì„±í•œ Issueê°€ ì—†ìŠµë‹ˆë‹¤.</p>\n");
        } else {
            for (Issue issue : userIssues) {
                String state = "closed".equals(issue.getState()) ? "âœ…" : "ğŸ”„";
                html.append(String.format("        <div class=\"list-item\">%s %s <small>(Issue #%d)</small></div>\n",
                        state, issue.getTitle(), issue.getNumber()));
            }
        }

        html.append("        <div class=\"footer\">Generated by Tally</div>\n");
        html.append("    </div>\n");
        html.append("</body>\n");
        html.append("</html>\n");

        return Report.builder()
                .id(UUID.randomUUID().toString())
                .userId(username)
                .contributionStatsId(stats.getId())
                .format(Report.ReportFormat.HTML)
                .content(html.toString())
                .generatedAt(LocalDateTime.now())
                .build();
    }
}